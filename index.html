<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>El Resolvito | Tu Tienda a Domicilio en La Habana</title>
    <meta name="description" content="Encuentra víveres y más en El Resolvito. Haz tu pedido online y recíbelo en La Habana. Compra fácil y rápido por WhatsApp.">
    <meta name="keywords" content="tienda online habana, mercado habana, entrega a domicilio cuba, mandados habana, el resolvito">
    <meta name="author" content="El Resolvito">

    <!-- ========================================================= -->
    <!-- === BLOQUE DE ÍCONOS Y MANIFEST PROFESIONAL (HÍBRIDO) === -->
    <!-- ========================================================= -->
    <link rel="manifest" href="manifest.json?v=5">
    <meta name="theme-color" content="#0d3b33">
    <link rel="apple-touch-icon" href="android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d3b33;
            --accent-color: #c94a37;
            --background-white: #ffffff;
            --light-background-gray: #f9fafb;
            --text-dark: #1f2937;
            --text-medium: #4b5563;
            --dark-overlay: rgba(0, 0, 0, 0.6);
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-background-gray); }
        .text-fixed-sm { font-size: 0.75rem; } @media (min-width: 768px) { .text-fixed-sm { font-size: 0.875rem; } }
        .text-fixed-base { font-size: 0.875rem; } @media (min-width: 768px) { .text-fixed-base { font-size: 1rem; } }
        .text-fixed-lg { font-size: 1rem; } @media (min-width: 768px) { .text-fixed-lg { font-size: 1.125rem; } }
        .text-fixed-xl { font-size: 1.125rem; } @media (min-width: 768px) { .text-fixed-xl { font-size: 1.25rem; } }
        .text-fixed-2xl { font-size: 1.25rem; } @media (min-width: 768px) { .text-fixed-2xl { font-size: 1.5rem; } }
        .text-fixed-3xl { font-size: 1.5rem; } @media (min-width: 768px) { .text-fixed-3xl { font-size: 1.875rem; } }
        .text-fixed-4xl { font-size: 1.875rem; } @media (min-width: 768px) { .text-fixed-4xl { font-size: 2.25rem; } }
        .text-fixed-6xl { font-size: 2.5rem; } @media (min-width: 768px) { .text-fixed-6xl { font-size: 3.75rem; } }
        .hero-banner { background-image: url('https://i.postimg.cc/rsCKV7LZ/1755367982611.jpg'); background-size: cover; background-position: center; }
        .hero-overlay { background-color: var(--dark-overlay); }
        header.scrolled { background-color: rgba(13, 59, 51, 0.95); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .modal-overlay { opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { transform: translateY(-20px); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-overlay.show .modal-content { transform: translateY(0); opacity: 1; }
        #mobile-menu { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        #mobile-menu.open { transform: translateX(0); }
        #mobile-backdrop { opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        #mobile-backdrop.open { opacity: 1; visibility: visible; }
        .unit-type-btn.active { background-color: var(--primary-color); color: white; }
        .shake { animation: shake-animation 0.6s ease-in-out; }
        @keyframes shake-animation { 0% { transform: translateX(0); } 15% { transform: translateX(-8px) rotate(-5deg); } 30% { transform: translateX(8px) rotate(5deg); } 45% { transform: translateX(-8px) rotate(-5deg); } 60% { transform: translateX(8px) rotate(5deg); } 75% { transform: translateX(-5px) rotate(-2deg); } 90% { transform: translateX(5px) rotate(2deg); } 100% { transform: translateX(0); } }
        .cash-btn { border: 1px solid #d1d5db; padding: 8px 12px; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; }
        .cash-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .fade-in-up, .fade-in-left, .fade-in-right { opacity: 0; transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .fade-in-up { transform: translateY(30px); }
        .fade-in-left { transform: translateX(-30px); }
        .fade-in-right { transform: translateX(30px); }
        .is-visible { opacity: 1; transform: none; }
        .category-btn { background-color: #f3f4f6; color: var(--text-medium); padding: 8px 16px; border-radius: 9999px; font-weight: 600; transition: all 0.2s; border: 1px solid transparent; }
        .category-btn:hover { background-color: #e5e7eb; }
        .category-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    </style>
</head>
<body class="text-gray-800">

<header id="mainHeader" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between py-2">
        <div class="flex items-center gap-4">
            <button id="mobile-menu-button" class="md:hidden text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
            <a href="#" class="flex items-center gap-3 flex-shrink-0">
                <img src="https://i.postimg.cc/s2FHrX2Y/logo_el_resolvito.jpg" class="h-12 w-12 md:h-16 md:w-16 rounded-full shadow-md object-cover">
                <span class="text-white text-fixed-lg md:text-xl font-bold hidden sm:block">El Resolvito</span>
            </a>
        </div>
        <nav class="hidden md:flex items-center gap-4 md:gap-6 text-white font-semibold">
            <a href="#mercado" class="text-fixed-lg hover:text-gray-300 transition-colors duration-300">Mercado</a>
            <a href="#como-comprar" class="text-fixed-lg hover:text-gray-300 transition-colors duration-300">¿Cómo Comprar?</a>
            <a href="#contacto" class="text-fixed-lg hover:text-gray-300 transition-colors duration-300">Contacto</a>
        </nav>
    </div>
</header>

<div id="mobile-menu" class="fixed top-0 left-0 h-full w-64 bg-[var(--primary-color)] z-50 shadow-xl md:hidden">
    <div class="p-6">
        <div class="flex justify-between items-center mb-8">
            <a href="#" class="flex items-center gap-2">
                <img src="https://i.postimg.cc/s2FHrX2Y/logo_el_resolvito.jpg" alt="El Resolvito Logo" class="h-12 w-12 rounded-full object-cover">
                <span class="text-white text-fixed-lg font-bold">El Resolvito</span>
            </a>
            <button id="close-mobile-menu" class="text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <nav class="flex flex-col space-y-4 text-fixed-lg font-semibold text-white">
            <a href="#mercado" class="hover:text-gray-300 transition-colors mobile-nav-link">Mercado</a>
            <a href="#como-comprar" class="hover:text-gray-300 transition-colors mobile-nav-link">¿Cómo Comprar?</a>
            <a href="#contacto" class="hover:text-gray-300 transition-colors mobile-nav-link">Contacto</a>
        </nav>
    </div>
</div>
<div id="mobile-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>

<main>
    <section class="hero-banner relative pt-24 pb-16 md:pt-32 md:pb-24">
        <div class="hero-overlay absolute inset-0 opacity-75"></div>
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center text-white">
            <h1 class="text-fixed-4xl md:text-fixed-6xl font-extrabold mb-4 drop-shadow-lg fade-in-up">EL RESOLVITO</h1>
            <p class="text-fixed-lg md:text-fixed-xl max-w-2xl mx-auto mb-8 drop-shadow-md fade-in-up" style="transition-delay: 150ms;">Tu tienda a un clic de distancia.</p>
            <a href="#mercado" class="bg-[var(--accent-color)] text-white font-bold py-3 px-8 rounded-full text-fixed-lg hover:bg-opacity-90 transform hover:scale-105 transition-all duration-300 shadow-lg fade-in-up" style="transition-delay: 300ms;">Explorar Productos</a>
        </div>
    </section>

    <section id="mercado" class="py-16 lg:py-24 bg-gray-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12 fade-in-up">
                <h2 class="text-fixed-3xl md:text-fixed-4xl font-bold text-[var(--text-dark)]">Nuestros Productos</h2>
                <p class="mt-4 text-fixed-lg text-[var(--text-medium)] max-w-3xl mx-auto">Encuentra todo lo que necesitas para tu hogar, desde víveres hasta productos de aseo.</p>
            </div>
            
            <div class="bg-white border-2 border-dashed border-green-200 p-4 rounded-xl shadow-md mb-8 text-center fade-in-up">
                <h3 class="text-fixed-lg md:text-fixed-xl font-bold text-[var(--primary-color)] mb-3">¡Ahorra en cada pedido en La Habana Vieja!</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm md:text-base">
                    <div class="bg-green-50 p-3 rounded-lg">
                        <p class="font-semibold text-gray-800">Compras de $1,500+</p>
                        <p class="text-green-700 font-bold">Paga solo $50 de envío</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg ring-2 ring-[var(--accent-color)]">
                        <p class="font-semibold text-gray-800">Compras de $3,500+</p>
                        <p class="text-[var(--accent-color)] font-extrabold text-lg">¡ENVÍO GRATIS!</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <p class="font-semibold text-gray-800">Tarifa Regular</p>
                        <p class="text-gray-600 font-bold">$150</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg mb-8 fade-in-up" style="transition-delay: 150ms;">
                <input type="text" id="mercadoSearchInput" placeholder="Buscar productos..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition text-fixed-base">
            </div>
            <div id="mercadoCategoryFilters" class="flex flex-wrap justify-center gap-2 mb-8 fade-in-up" style="transition-delay: 300ms;"></div>
            <div id="mercadoProductGrid"></div>
            <p id="mercadoNoResultsMessage" class="hidden text-center text-fixed-lg text-[var(--text-medium)] mt-8">No se encontraron productos que coincidan con tu búsqueda.</p>
        </div>
    </section>
    
    <section id="como-comprar" class="py-16 lg:py-24 bg-white">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12 fade-in-up">
                <h2 class="text-fixed-3xl md:text-fixed-4xl font-bold text-[var(--text-dark)]">¿Cómo Comprar?</h2>
                <p class="mt-4 text-fixed-lg text-[var(--text-medium)] max-w-3xl mx-auto">Hacer tu pedido es muy fácil. Sigue estos sencillos pasos para recibir tus productos sin complicaciones.</p>
            </div>
            <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6 text-center">
                <div class="fade-in-left"><div class="text-fixed-4xl mb-4 text-[var(--primary-color)]">1.</div><h3 class="text-fixed-xl font-bold mb-2">Elige Productos</h3><p class="text-fixed-base text-[var(--text-medium)]">Navega por nuestra tienda y añade los artículos que desees a tu carrito.</p></div>
                <div class="flex items-center justify-center text-gray-300 text-fixed-4xl font-light hidden md:flex">→</div>
                <div class="fade-in-right" style="transition-delay: 150ms;"><div class="text-fixed-4xl mb-4 text-[var(--primary-color)]">2.</div><h3 class="text-fixed-xl font-bold mb-2">Revisa tu Carrito</h3><p class="text-fixed-base text-[var(--text-medium)]">Abre tu carrito, revisa tu selección y pulsa "Enviar Pedido".</p></div>
                <div class="flex items-center justify-center text-gray-300 text-fixed-4xl font-light hidden md:flex">→</div>
                <div class="fade-in-left" style="transition-delay: 300ms;"><div class="text-fixed-4xl mb-4 text-[var(--primary-color)]">3.</div><h3 class="text-fixed-xl font-bold mb-2">Completa tus Datos</h3><p class="text-fixed-base text-[var(--text-medium)]">Llena el formulario con tu información de contacto y entrega.</p></div>
                <div class="flex items-center justify-center text-gray-300 text-fixed-4xl font-light hidden md:flex">→</div>
                <div class="fade-in-right" style="transition-delay: 450ms;"><div class="text-fixed-4xl mb-4 text-[var(--primary-color)]">4.</div><h3 class="text-fixed-xl font-bold mb-2">Confirma y Recibe</h3><p class="text-fixed-base text-[var(--text-medium)]">Confirma por WhatsApp y coordinamos la entrega a tu puerta.</p></div>
            </div>
            <div class="mt-12 max-w-4xl mx-auto bg-blue-50 p-6 rounded-xl fade-in-up">
                <h3 class="text-fixed-xl font-bold text-[var(--text-dark)] mb-4 text-center">Nuestra Política de Envíos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="text-center">
                        <h4 class="font-bold text-[var(--primary-color)] mb-2">Habana Vieja</h4>
                        <ul class="list-none space-y-1 text-fixed-sm text-[var(--text-medium)]">
                            <li>• Tarifa regular: <strong class="text-[var(--text-dark)]">$150 CUP</strong></li>
                            <li>• En compras de $1,500 o más: <strong class="text-green-600">¡Paga solo $50 CUP de envío!</strong></li>
                            <li>• En compras de $3,500 o más: <strong class="text-green-600">¡Tu envío es TOTALMENTE GRATIS!</strong></li>
                        </ul>
                    </div>
                    <div class="text-center">
                        <h4 class="font-bold text-[var(--primary-color)] mb-2">Otros Municipios</h4>
                        <p class="text-fixed-sm text-[var(--text-medium)]">• Costo según agencia de mensajería.</p>
                        <p class="text-fixed-sm text-[var(--text-medium)]">• Te confirmaremos el precio por WhatsApp.</p>
                    </div>
                </div>
                <div class="text-center mt-6 border-t pt-4">
                    <p class="font-bold text-gray-800">Horarios de Reparto:</p>
                    <p class="text-fixed-sm text-[var(--text-medium)]">Pedidos recibidos antes de las 11:00 AM se entregan de 12 PM a 2 PM.</p>
                    <p class="text-fixed-sm text-[var(--text-medium)]">Pedidos recibidos antes de las 4:00 PM se entregan de 5 PM a 7 PM.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="contacto" class="py-16 lg:py-24">
         <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12 fade-in-up">
                <h2 class="text-fixed-3xl md:text-fixed-4xl font-bold text-[var(--text-dark)]">Únete a Nuestro Club de Ofertas</h2>
                <p class="mt-4 text-fixed-lg text-[var(--text-medium)] max-w-3xl mx-auto">Sé el primero en enterarte de nuevos productos y promociones exclusivas uniéndote a nuestro grupo de WhatsApp.</p>
            </div>
            <div class="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-lg text-center fade-in-up" style="transition-delay: 150ms;">
                <div class="space-y-4">
                    <p class="text-fixed-lg"><strong>Canal de anuncios:</strong> Solo administradores</p>
                    <p class="text-fixed-lg"><strong>Cero spam,</strong> solo información útil.</p>
                </div>
                <a href="#" id="contactWhatsappBtn" class="mt-8 inline-block bg-green-500 text-white font-bold py-3 px-8 rounded-full text-fixed-lg hover:bg-green-600 transform hover:scale-105 transition-all duration-300 shadow-lg">Unirse al Grupo de WhatsApp</a>
            </div>
         </div>
    </section>
</main>

<footer class="bg-[var(--text-dark)] text-white py-8">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400">
        <div class="flex justify-center items-center gap-6 mb-6">
            <a href="https://wa.me/5356382909?text=¡Hola!%20Me%20interesa%20hacer%20un%20pedido." target="_blank" class="text-gray-400 hover:text-white transition-transform hover:scale-110"><svg class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C7.38 2 3.51 5.87 3.51 10.53C3.51 12.02 3.9 13.43 4.6 14.65L3.32 20.02L8.76 18.73C9.9 19.37 11.19 19.72 12.51 19.72H12.53C17.19 19.72 21.06 15.85 21.06 11.19C21.06 6.53 17.19 2.66 12.53 2.66H12.51Z"/></svg></a>
        </div>
        <p class="text-fixed-sm">&copy; 2024 El Resolvito. Todos los derechos reservados.</p>
    </div>
</footer>
    
<!-- Modals (Carrito, Detalles de Producto, Checkout) -->
<div id="cartModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
        <div class="p-6 border-b"><div class="flex justify-between items-center"><h3 class="text-fixed-xl font-bold text-[var(--text-dark)]">Tu Carrito</h3><button id="closeCartModal" class="text-gray-500 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div></div>
        <div id="cartItems" class="p-6 overflow-y-auto"><p class="text-center text-[var(--text-medium)] text-fixed-base">Tu carrito está vacío</p></div>
        <div class="p-6 border-t"><div class="flex justify-between items-center mb-4"><span class="text-fixed-lg font-bold">Total:</span><span id="cartTotal" class="text-fixed-lg font-bold text-[var(--primary-color)]">$0</span></div><button id="sendWhatsAppOrder" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-fixed-base hover:bg-green-600 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Enviar Pedido por WhatsApp</button></div>
    </div>
</div>
<div id="productDetailsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[1000]">
    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b"><h2 id="productDetailsTitle" class="text-fixed-2xl font-bold"></h2><button id="closeProductDetailsModalBtn" class="text-gray-500 hover:text-gray-800 text-fixed-3xl">&times;</button></div>
        <div class="p-6 overflow-y-auto">
            <img id="productDetailsImage" src="" alt="Imagen del Producto" class="w-full h-64 object-contain rounded-lg mb-4">
            <p id="productDetailsDescription" class="text-fixed-base text-[var(--text-medium)] mb-4"></p>
            <div id="unitTypeSection" class="mb-4 hidden">
                <label class="block text-fixed-base font-semibold text-gray-700 mb-2">Tipo de compra:</label>
                <div class="flex gap-2">
                    <button id="unitTypeIndividual" class="unit-type-btn flex-1 py-2 px-4 border border-gray-300 rounded-lg text-fixed-sm font-medium transition-colors active">Individual</button>
                    <button id="unitTypeBox" class="unit-type-btn flex-1 py-2 px-4 border border-gray-300 rounded-lg text-fixed-sm font-medium transition-colors">Por Caja (24 unidades)</button>
                </div>
            </div>
            <p id="productDetailsPrice" class="text-fixed-3xl font-bold text-[var(--primary-color)] mb-6 text-center"></p>
            <div class="flex items-center justify-center space-x-4 mb-4">
                <button id="decreaseQuantityBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold w-10 h-10 rounded-full text-fixed-xl">-</button>
                <span id="productQuantityDisplay" class="text-fixed-2xl font-bold w-12 text-center">1</span>
                <button id="increaseQuantityBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold w-10 h-10 rounded-full text-fixed-xl">+</button>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg mb-4"><div class="flex justify-between items-center"><span class="text-fixed-lg font-semibold">Total:</span><span id="modalTotalPrice" class="text-fixed-2xl font-bold text-[var(--accent-color)]">$0</span></div></div>
            <button id="addProductToCartModalBtn" class="w-full bg-[var(--accent-color)] text-white font-bold py-3 px-6 rounded-lg hover:bg-opacity-90 transition-all duration-300 text-fixed-lg">Añadir al Carrito</button>
        </div>
    </div>
</div>
<div id="checkoutModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden">
        <div class="p-6 border-b"><div class="flex justify-between items-center"><h3 class="text-fixed-2xl font-bold text-[var(--text-dark)]">Finalizar Pedido</h3><button id="closeCheckoutModal" class="text-gray-500 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div></div>
        <div class="flex-1 overflow-y-auto">
            <div class="p-6 border-b">
                <h4 class="text-fixed-lg font-bold text-[var(--text-dark)] mb-4">1. Resumen de tu Pedido</h4>
                <div id="checkoutOrderSummary" class="space-y-3 mb-4"></div>
                <div id="upsellMessage" class="my-4 p-3 rounded-lg text-center font-semibold text-sm transition-all duration-300" style="display: none;"></div>
                <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                    <div class="flex justify-between text-fixed-base"><span>Subtotal de productos:</span><span id="checkoutSubtotal" class="font-semibold">$0</span></div>
                    <div class="flex justify-between text-fixed-base text-gray-600"><span>Servicio y Empaque:</span><span id="checkoutServiceFee" class="font-semibold">$50</span></div>
                    <div class="flex justify-between text-fixed-base"><span>Costo de envío:</span><span id="checkoutShipping" class="font-semibold">$0</span></div>
                    <div id="shippingNote" class="text-fixed-sm text-gray-600 hidden"></div>
                    <hr class="my-2">
                    <div class="flex justify-between text-fixed-lg font-bold text-[var(--primary-color)]"><span>Total a Pagar:</span><span id="checkoutTotal">$0</span></div>
                </div>
            </div>
            <div class="p-6 border-b"><h4 class="text-fixed-lg font-bold text-[var(--text-dark)] mb-4">2. Datos de Contacto</h4><div class="space-y-4"><div><label for="customerName" class="block text-fixed-base font-semibold text-gray-700 mb-2">Nombre completo *</label><input type="text" id="customerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition text-fixed-base" required></div><div><label for="customerAddress" class="block text-fixed-base font-semibold text-gray-700 mb-2">Calle y número (ej: Aguiar #230 apto 1) *</label><input type="text" id="customerAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition text-fixed-base" required></div><div><label for="customerReferences" class="block text-fixed-base font-semibold text-gray-700 mb-2">Puntos de Referencia (ej: Frente a la bodega)</label><input type="text" id="customerReferences" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition text-fixed-base"></div><div><label for="customerPhone" class="block text-fixed-base font-semibold text-gray-700 mb-2">Número de teléfono *</label><input type="tel" id="customerPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition text-fixed-base" required></div><div><label for="deliveryLocation" class="block text-fixed-base font-semibold text-gray-700 mb-2">Ubicación *</label><select id="deliveryLocation" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition text-fixed-base" required><option value="">Selecciona tu ubicación</option><option value="habana-vieja">Habana Vieja</option><option value="otros">Otros municipios</option></select></div></div></div>
            <div class="p-6 border-b"><h4 class="text-fixed-lg font-bold text-[var(--text-dark)] mb-4">3. Detalles del Pago</h4><div class="space-y-4"><div><label class="block text-fixed-base font-semibold text-gray-700 mb-2">Método de pago *</label><div class="space-y-2"><label class="flex items-center"><input type="radio" name="paymentMethod" value="efectivo" class="mr-3 text-[var(--primary-color)] focus:ring-[var(--primary-color)]"><span class="text-fixed-base">Efectivo</span></label><label class="flex items-center"><input type="radio" name="paymentMethod" value="transferencia" class="mr-3 text-[var(--primary-color)] focus:ring-[var(--primary-color)]"><span class="text-fixed-base">Transferencia</span></label></div></div><div id="cashPaymentField" class="hidden"><label class="block text-fixed-base font-semibold text-gray-700 mb-2">Pagaré con...</label><div class="flex flex-wrap gap-2"><button type="button" class="cash-btn" data-amount="20">$20</button><button type="button" class="cash-btn" data-amount="50">$50</button><button type="button" class="cash-btn" data-amount="100">$100</button><button type="button" class="cash-btn" data-amount="200">$200</button><button type="button" class="cash-btn" data-amount="500">$500</button><button type="button" class="cash-btn" data-amount="1000">$1000</button><button type="button" class="cash-btn" data-amount="otro">Otro</button></div><input type="text" id="otherCashAmount" placeholder="Especifica otro monto" class="hidden w-full mt-2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] transition text-fixed-base"></div></div></div>
            <div class="p-6"><h4 class="text-fixed-lg font-bold text-[var(--text-dark)] mb-4">4. Política de Envíos</h4><div class="bg-blue-50 p-4 rounded-lg text-fixed-sm text-gray-700 space-y-2"><p><strong>Horarios de entrega:</strong> 9:00 a.m. a 8:00 p.m.</p><p><strong>Habana Vieja:</strong></p><ul class="list-disc list-inside ml-4 space-y-1"><li>Tarifa regular: <strong>$150 CUP</strong></li><li class="font-semibold text-green-600">En compras de $1,500 o más: <strong>¡Paga solo $50 CUP!</strong></li><li class="font-semibold text-green-600">En compras de $3,500 o más: <strong>¡Envío GRATIS!</strong></li></ul><p><strong>Otros municipios:</strong></p><ul class="list-disc list-inside ml-4 space-y-1"><li>El costo de envío se ajustará al precio de la agencia de mensajería externa</li><li>Se lo confirmaremos por WhatsApp antes de procesar su pedido</li></ul><p class="text-xs text-gray-600 mt-3">Al confirmar su pedido, acepta nuestras condiciones de envío y horarios establecidos.</p></div></div>
        </div>
        <div class="p-6 border-t bg-gray-50"><button id="confirmOrderBtn" class="w-full bg-green-500 text-white font-bold py-4 px-4 rounded-lg text-fixed-base hover:bg-green-600 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]">Confirmar y Enviar Pedido</button></div>
    </div>
</div>

<!-- BOTÓN DEL CARRITO MODIFICADO -->
<button id="floatingCartBtn" class="fixed bottom-6 right-6 bg-[var(--primary-color)] text-white px-5 py-3 rounded-full shadow-lg hover:bg-opacity-90 transition-all duration-300 transform hover:scale-105 z-40 flex items-center gap-3">
    <div class="relative">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .49.598l-1 5a.5.5 0 0 1-.465.402H3.62a.5.5 0 0 1-.49-.598l-1-5A.5.5 0 0 1 2 1H.5a.5.5 0 0 1-.5-.5zM3.14 5l.5 2.5h7.45l.5-2.5H3.14zM5 12a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z"/>
        </svg>
        <span id="cartCount" class="absolute -top-1 -right-1 bg-[var(--accent-color)] text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">0</span>
    </div>
    <span id="floatingCartTotal" class="text-fixed-lg font-bold">$0</span>
</button>

<script>
    // Variables globales
    var products = [];
    var cart = JSON.parse(localStorage.getItem('cart')) || [];
    var whatsappGroupLink = 'https://chat.whatsapp.com/H19dIofkINdHrVApA4jbvW?mode=ac_t';
    var currentProductForModal = null;
    var currentUnitType = 'individual';
    var selectedCashAmount = '';

    // Función principal que se ejecuta cuando la página carga
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Cargamos el inventario desde productos.json
        fetch('productos.json?v=' + new Date().getTime()) // El '?v=' evita problemas de caché
            .then(response => {
                if (!response.ok) {
                    throw new Error('La respuesta de la red no fue correcta: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // 2. Si la carga es exitosa, guardamos los productos
                products = data;
                
                // 3. Con los productos cargados, inicializamos la tienda
                initializeStore();
            })
            .catch(error => {
                // 4. Si hay un error, lo mostramos
                console.error("¡Error fatal! No se pudo cargar el catálogo de productos.", error);
                document.getElementById('mercadoProductGrid').innerHTML = '<p class="text-center text-red-500 font-bold">No se pudo cargar el catálogo de productos en este momento. Por favor, intente más tarde.</p>';
            });
    });

    // Nueva función que inicializa toda la tienda DESPUÉS de que los productos se cargan
    function initializeStore() {
        // Ordenamos los productos
        products.sort((a, b) => {
            if (a.category < b.category) return -1;
            if (a.category > b.category) return 1;
            if (a.name < b.name) return -1;
            if (a.name > b.name) return 1;
            return 0;
        });
        
        // Ejecutamos el resto de las funciones de la tienda
        setupStoreSection('mercado', products);
        updateCartUI();
        setupGeneralEventListeners();
        setupScrollAnimations();
        setupScrollHeader();
    }

    function setupStoreSection(sectionPrefix, productsForSection) {
        var filtersId = sectionPrefix + 'CategoryFilters';
        var searchId = sectionPrefix + 'SearchInput';
        var gridId = sectionPrefix + 'ProductGrid';
        var noResultsId = sectionPrefix + 'NoResultsMessage';
        setupCategoryFiltersAndSearch(productsForSection, filtersId, searchId, gridId, noResultsId);
        renderProducts(productsForSection, gridId, noResultsId);
    }
    
    function setupCategoryFiltersAndSearch(productsForSection, filtersId, searchId, gridId, noResultsId) {
        var uniqueCategories = [];
        for (var i = 0; i < productsForSection.length; i++) {
            if (uniqueCategories.indexOf(productsForSection[i].category) === -1) {
                uniqueCategories.push(productsForSection[i].category);
            }
        }

        var categories = ['all'].concat(uniqueCategories);
        var filtersContainer = document.getElementById(filtersId);
        if (!filtersContainer) return;

        var buttonsHtml = categories.map(function(category) {
            return '<button class="category-btn ' + (category === 'all' ? 'active' : '') + '" data-category="' + category + '">' + (category === 'all' ? 'Todos' : category) + '</button>';
        }).join('');
        filtersContainer.innerHTML = buttonsHtml;

        var currentCategory = 'all';
        var categoryButtons = filtersContainer.querySelectorAll('.category-btn');
        var searchInput = document.getElementById(searchId);

        function filterAndRender() {
            var searchTerm = searchInput.value.toLowerCase();
            var filteredProducts = [];
            for (var i = 0; i < productsForSection.length; i++) {
                var product = productsForSection[i];
                var categoryMatch = (currentCategory === 'all' || product.category === currentCategory);
                var searchMatch = (!searchTerm || product.name.toLowerCase().indexOf(searchTerm) > -1 || product.description.toLowerCase().indexOf(searchTerm) > -1);
                if (categoryMatch && searchMatch) {
                    filteredProducts.push(product);
                }
            }
            renderProducts(filteredProducts, gridId, noResultsId);
        }

        for (var j = 0; j < categoryButtons.length; j++) {
            categoryButtons[j].addEventListener('click', function() {
                for (var k = 0; k < categoryButtons.length; k++) { categoryButtons[k].classList.remove('active'); }
                this.classList.add('active');
                currentCategory = this.getAttribute('data-category');
                filterAndRender();
            });
        }
        searchInput.addEventListener('input', filterAndRender);
    }

    function renderProducts(productsToRender, gridId, noResultsId) {
        var productGrid = document.getElementById(gridId);
        var noResultsMessage = document.getElementById(noResultsId);
        if (!productGrid || !noResultsMessage) return;
        if (productsToRender.length === 0) {
            productGrid.innerHTML = '';
            noResultsMessage.classList.remove('hidden');
            return;
        }
        noResultsMessage.classList.add('hidden');
        
        var groupedProducts = productsToRender.reduce(function(acc, product) {
            (acc[product.category] = acc[product.category] || []).push(product);
            return acc;
        }, {});

        var html = '';
        var sortedCategories = Object.keys(groupedProducts).sort();

        for (var i = 0; i < sortedCategories.length; i++) {
            var category = sortedCategories[i];
            if (groupedProducts.hasOwnProperty(category)) {
                html += '<div class="col-span-full fade-in-up"><h3 class="text-2xl font-bold text-center text-[var(--primary-color)] my-8 border-b-2 border-gray-200 pb-2">— ' + category + ' —</h3></div>';
                html += groupedProducts[category].map(function(product, index) {
                    return '<div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer fade-in-up" style="transition-delay: ' + (index * 50) + 'ms" onclick="showProductDetailsModal(' + product.id + ')">' +
                           '<div class="w-full h-56 md:h-64 overflow-hidden bg-transparent flex items-center justify-center"><img src="' + product.image + '" alt="' + product.name + '" class="w-full h-full object-contain transition-all duration-300"></div>' +
                           '<div class="p-4">' +
                           '<h3 class="text-fixed-lg font-bold text-[var(--text-dark)] mb-2">' + product.name + '</h3>' +
                           '<p class="text-fixed-sm text-[var(--text-medium)] mb-2">' + product.description + '</p>' +
                           '<p class="text-fixed-xl font-bold text-[var(--primary-color)] mb-4">$' + product.price.toLocaleString() + '</p>' +
                           (product.status === 'unavailable' ? '<span class="text-red-500 text-fixed-sm font-semibold">No disponible</span>' : '<button class="w-full bg-[var(--primary-color)] text-white font-bold py-2 px-4 rounded-lg text-fixed-base hover:bg-opacity-90 transition-colors duration-300">Ver Detalles</button>') +
                           '</div></div>';
                }).join('');
            }
        }
        productGrid.innerHTML = '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">' + html + '</div>';
        setupScrollAnimations();
    }
    
    function showProductDetailsModal(productId){var product=null;for(var i=0;i<products.length;i++){if(products[i].id===productId){product=products[i];break;}}
    if(!product||product.status==='unavailable')return;currentProductForModal=JSON.parse(JSON.stringify(product));currentProductForModal.quantity=1;currentUnitType='individual';document.getElementById('productDetailsTitle').textContent=product.name;document.getElementById('productDetailsImage').src=product.image;document.getElementById('productDetailsDescription').textContent=product.description;document.getElementById('productQuantityDisplay').textContent='1';var unitTypeSection=document.getElementById('unitTypeSection');if(product.hasBoxOption){unitTypeSection.classList.remove('hidden');updateUnitTypeButtons();}else{unitTypeSection.classList.add('hidden');}
    updateModalPricing();document.getElementById('productDetailsModal').classList.add('show');}
    function updateUnitTypeButtons(){var individualBtn=document.getElementById('unitTypeIndividual');var boxBtn=document.getElementById('unitTypeBox');if(currentUnitType==='individual'){individualBtn.classList.add('active');boxBtn.classList.remove('active');}else{boxBtn.classList.add('active');individualBtn.classList.remove('active');}}
    function updateModalPricing(){if(!currentProductForModal)return;var unitPrice,unitDescription;if(currentProductForModal.hasBoxOption&&currentUnitType==='box'){unitPrice=currentProductForModal.boxPrice;unitDescription='Caja ('+currentProductForModal.boxQuantity+' unidades)';}else{unitPrice=currentProductForModal.price;unitDescription='Unidad';}
    var totalPrice=unitPrice*currentProductForModal.quantity;document.getElementById('productDetailsPrice').textContent='$'+unitPrice.toLocaleString()+' / '+unitDescription;document.getElementById('modalTotalPrice').textContent='$'+totalPrice.toLocaleString();}
    function addToCartFromModal(){if(!currentProductForModal)return;var cartItem={id:currentProductForModal.id+(currentUnitType==='box'?'_box':''),name:currentProductForModal.name,image:currentProductForModal.image,quantity:currentProductForModal.quantity,unitType:currentUnitType};if(currentProductForModal.hasBoxOption&&currentUnitType==='box'){cartItem.price=currentProductForModal.boxPrice;cartItem.name+=' (Caja x'+currentProductForModal.boxQuantity+')';}else{cartItem.price=currentProductForModal.price;}
    var existingItemIndex=-1;for(var i=0;i<cart.length;i++){if(cart[i].id===cartItem.id){existingItemIndex=i;break;}}
    if(existingItemIndex!==-1){cart[existingItemIndex].quantity+=cartItem.quantity;}else{cart.push(cartItem);}
    updateCartUI();localStorage.setItem('cart',JSON.stringify(cart));document.getElementById('productDetailsModal').classList.remove('show');currentProductForModal=null;showCartAnimation();}
    
    function updateCartUI(){
        var totalItems=cart.reduce(function(sum,item){return sum+item.quantity;},0);
        var totalPrice=cart.reduce(function(sum,item){return sum+(item.price*item.quantity);},0);
        document.getElementById('cartCount').textContent=totalItems;
        document.getElementById('cartTotal').textContent='$'+totalPrice.toLocaleString();
        document.getElementById('floatingCartTotal').textContent = '$' + totalPrice.toLocaleString();
        var cartItems=document.getElementById('cartItems');
        var sendWhatsAppOrder=document.getElementById('sendWhatsAppOrder');
        if(cart.length===0){
            cartItems.innerHTML='<p class="text-center text-[var(--text-medium)] text-fixed-base">Tu carrito está vacío</p>';
            sendWhatsAppOrder.disabled=true;
        }else{
            cartItems.innerHTML=cart.map(function(item,index){return('<div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">'+
            '<div class="flex-1"><h4 class="text-fixed-base font-semibold text-[var(--text-dark)]">'+item.name+'</h4><p class="text-fixed-sm text-[var(--text-medium)]">$'+item.price.toLocaleString()+' c/u</p></div>'+
            '<div class="flex items-center gap-2">'+
            '<button onclick="updateCartQuantity('+index+', '+(item.quantity-1)+')" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-fixed-sm font-bold hover:bg-gray-300 transition-colors">-</button>'+
            '<span class="text-fixed-base font-semibold w-8 text-center">'+item.quantity+'</span>'+
            '<button onclick="updateCartQuantity('+index+', '+(item.quantity+1)+')" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-fixed-sm font-bold hover:bg-gray-300 transition-colors">+</button>'+
            '<button onclick="removeFromCart('+index+')" class="ml-2 text-red-500 hover:text-red-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>'+
            '</div></div>');
        }).join('');
        sendWhatsAppOrder.disabled=false;
        }
    }

    function updateCartQuantity(index,newQuantity){if(newQuantity<=0){removeFromCart(index);return;} cart[index].quantity=newQuantity;updateCartUI();localStorage.setItem('cart',JSON.stringify(cart));}
    function removeFromCart(index){cart.splice(index,1);updateCartUI();localStorage.setItem('cart',JSON.stringify(cart));}
    function showCartAnimation(){var floatingCartBtn=document.getElementById('floatingCartBtn');floatingCartBtn.classList.add('shake');setTimeout(function(){floatingCartBtn.classList.remove('shake');},600);}
    function setupGeneralEventListeners(){document.getElementById('floatingCartBtn').addEventListener('click',function(){document.getElementById('cartModal').classList.add('show');});document.getElementById('closeCartModal').addEventListener('click',function(){document.getElementById('cartModal').classList.remove('show');});document.getElementById('cartModal').addEventListener('click',function(e){if(e.target.id==='cartModal')document.getElementById('cartModal').classList.remove('show');});document.getElementById('closeProductDetailsModalBtn').addEventListener('click',function(){document.getElementById('productDetailsModal').classList.remove('show');currentProductForModal=null;});document.getElementById('productDetailsModal').addEventListener('click',function(e){if(e.target.id==='productDetailsModal'){document.getElementById('productDetailsModal').classList.remove('show');currentProductForModal=null;}});document.getElementById('unitTypeIndividual').addEventListener('click',function(){currentUnitType='individual';updateUnitTypeButtons();updateModalPricing();});document.getElementById('unitTypeBox').addEventListener('click',function(){currentUnitType='box';updateUnitTypeButtons();updateModalPricing();});document.getElementById('decreaseQuantityBtn').addEventListener('click',function(){if(currentProductForModal&&currentProductForModal.quantity>1){currentProductForModal.quantity--;document.getElementById('productQuantityDisplay').textContent=currentProductForModal.quantity;updateModalPricing();}});document.getElementById('increaseQuantityBtn').addEventListener('click',function(){if(currentProductForModal){currentProductForModal.quantity++;document.getElementById('productQuantityDisplay').textContent=currentProductForModal.quantity;updateModalPricing();}});document.getElementById('addProductToCartModalBtn').addEventListener('click',addToCartFromModal);document.getElementById('sendWhatsAppOrder').addEventListener('click',function(){document.getElementById('cartModal').classList.remove('show');showCheckoutModal();});document.getElementById('contactWhatsappBtn').addEventListener('click',function(e){e.preventDefault();window.open(whatsappGroupLink,'_blank');});document.getElementById('mobile-menu-button').addEventListener('click',function(){document.getElementById('mobile-menu').classList.add('open');document.getElementById('mobile-backdrop').classList.add('open');});document.getElementById('close-mobile-menu').addEventListener('click',closeMobileMenu);document.getElementById('mobile-backdrop').addEventListener('click',closeMobileMenu);
    var anchorLinks=document.querySelectorAll('a[href^="#"]');for(var i=0;i<anchorLinks.length;i++){anchorLinks[i].addEventListener('click',function(e){e.preventDefault();var targetId=this.getAttribute('href');var targetElement=document.querySelector(targetId);if(targetElement){if(this.classList.contains('mobile-nav-link')){closeMobileMenu();}
    setTimeout(function(){var targetPosition=targetElement.getBoundingClientRect().top+window.pageYOffset;var headerOffset=80;var offsetPosition=targetPosition-headerOffset;window.scrollTo(0,offsetPosition);},100);}});}
    setupCheckoutEventListeners();}
    function closeMobileMenu(){document.getElementById('mobile-menu').classList.remove('open');document.getElementById('mobile-backdrop').classList.remove('open');}
    function setupScrollAnimations(){if('IntersectionObserver' in window){var elements=document.querySelectorAll('.fade-in-up, .fade-in-left, .fade-in-right');var observer=new IntersectionObserver(function(entries){for(var i=0;i<entries.length;i++){if(entries[i].isIntersecting){entries[i].target.classList.add('is-visible');}}}, {threshold:0.1});for(var j=0;j<elements.length;j++){observer.observe(elements[j]);}}else{var elements=document.querySelectorAll('.fade-in-up, .fade-in-left, .fade-in-right');for(var k=0;k<elements.length;k++){elements[k].classList.add('is-visible');}}}
    function setupScrollHeader(){var header=document.getElementById('mainHeader');window.addEventListener('scroll',function(){if(window.scrollY>100){header.classList.add('scrolled');}else{header.classList.remove('scrolled');}});}
    
    function showCheckoutModal(){
        if(cart.length===0){alert('Tu carrito está vacío');return;}
        var savedData=JSON.parse(localStorage.getItem('customerData'));
        if(savedData){
            document.getElementById('customerName').value=savedData.name||'';
            document.getElementById('customerAddress').value=savedData.address||'';
            document.getElementById('customerReferences').value=savedData.references||'';
            document.getElementById('customerPhone').value=savedData.phone||'';
            document.getElementById('deliveryLocation').value='habana-vieja';
        }
        updateCheckoutSummary();
        document.getElementById('checkoutModal').classList.add('show');
    }
    
    function updateCheckoutSummary(){
        var checkoutOrderSummary=document.getElementById('checkoutOrderSummary');
        var subtotal=cart.reduce(function(sum,item){return sum+(item.price*item.quantity);},0);
        checkoutOrderSummary.innerHTML=cart.map(function(item){return('<div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">'+
        '<div class="flex-1"><h5 class="text-fixed-base font-semibold text-[var(--text-dark)]">'+item.name+'</h5><p class="text-fixed-sm text-[var(--text-medium)]">$'+item.price.toLocaleString()+' c/u × '+item.quantity+'</p></div>'+
        '<div class="text-fixed-base font-semibold">$'+(item.price*item.quantity).toLocaleString()+'</div></div>');
        }).join('');
        document.getElementById('checkoutSubtotal').textContent='$'+subtotal.toLocaleString();
        updateShippingAndTotal();
    }

    function updateShippingAndTotal() {
        var subtotal = cart.reduce(function(sum, item) { return sum + (item.price * item.quantity); }, 0);
        var serviceFee = 50;
        document.getElementById('checkoutServiceFee').textContent = '$' + serviceFee;
        var deliveryLocation = document.getElementById('deliveryLocation').value;
        var shippingCost = 0;
        var shippingText = '$0';
        var showNote = false;
        var noteText = '';
        var upsellMessage = '';
        var upsellElement = document.getElementById('upsellMessage');

        if (deliveryLocation === 'habana-vieja') {
            if (subtotal >= 3500) {
                shippingCost = 0;
                shippingText = 'GRATIS (Pedido Mayor a $3,500)';
                upsellMessage = '¡Felicidades! Has desbloqueado el Envío GRATIS.';
                upsellElement.className = 'my-4 p-3 rounded-lg text-center font-semibold text-sm bg-green-100 text-green-800';
            } else if (subtotal >= 1500) {
                shippingCost = 50;
                shippingText = 'Envío con Descuento: $50 CUP';
                var neededForFree = 3500 - subtotal;
                upsellMessage = '¡Estás a solo $' + neededForFree.toLocaleString() + ' de conseguir el Envío GRATIS!';
                upsellElement.className = 'my-4 p-3 rounded-lg text-center font-semibold text-sm bg-blue-100 text-blue-800';
            } else {
                shippingCost = 150;
                shippingText = '$150 CUP';
                var neededForDiscount = 1500 - subtotal;
                upsellMessage = '¡Añade $' + neededForDiscount.toLocaleString() + ' más a tu carrito y paga solo $50 de envío!';
                upsellElement.className = 'my-4 p-3 rounded-lg text-center font-semibold text-sm bg-yellow-100 text-yellow-800';
            }
        } else if (deliveryLocation === 'otros') {
            shippingCost = 0;
            shippingText = 'A confirmar';
            showNote = true;
            noteText = 'El costo de envío se ajustará al precio de la agencia de mensajería externa, se lo confirmaremos por WhatsApp.';
            upsellMessage = '';
        } else {
            upsellMessage = '';
        }

        if (upsellElement) {
            upsellElement.textContent = upsellMessage;
            if(upsellMessage === '') {
                upsellElement.style.display = 'none';
            } else {
                upsellElement.style.display = 'block';
            }
        }
        
        document.getElementById('checkoutShipping').textContent = shippingText;
        var shippingNote = document.getElementById('shippingNote');
        if (showNote) {
            shippingNote.textContent = noteText;
            shippingNote.classList.remove('hidden');
        } else {
            shippingNote.classList.add('hidden');
        }
        var total = subtotal + serviceFee + shippingCost;
        document.getElementById('checkoutTotal').textContent = '$' + total.toLocaleString();
    }

    function setupCheckoutEventListeners(){document.getElementById('closeCheckoutModal').addEventListener('click',function(){document.getElementById('checkoutModal').classList.remove('show');});document.getElementById('checkoutModal').addEventListener('click',function(e){if(e.target.id==='checkoutModal'){document.getElementById('checkoutModal').classList.remove('show');}});document.getElementById('deliveryLocation').addEventListener('change',updateShippingAndTotal);
    var paymentRadios=document.querySelectorAll('input[name="paymentMethod"]');for(var i=0;i<paymentRadios.length;i++){paymentRadios[i].addEventListener('change',function(){var cashField=document.getElementById('cashPaymentField');if(this.value==='efectivo'){cashField.classList.remove('hidden');}else{cashField.classList.add('hidden');selectedCashAmount='';var cashButtons=document.querySelectorAll('.cash-btn');for(var j=0;j<cashButtons.length;j++){cashButtons[j].classList.remove('active');}
    document.getElementById('otherCashAmount').classList.add('hidden');}});}
    var cashButtons=document.querySelectorAll('.cash-btn');for(var k=0;k<cashButtons.length;k++){cashButtons[k].addEventListener('click',function(){for(var l=0;l<cashButtons.length;l++){cashButtons[l].classList.remove('active');}
    this.classList.add('active');selectedCashAmount=this.getAttribute('data-amount');var otherInput=document.getElementById('otherCashAmount');if(selectedCashAmount==='otro'){otherInput.classList.remove('hidden');otherInput.focus();}else{otherInput.classList.add('hidden');}});}
    document.getElementById('confirmOrderBtn').addEventListener('click',confirmOrder);}
    function validateCheckoutForm(){var requiredFields=[{id:'customerName',name:'Nombre completo'},{id:'customerAddress',name:'Dirección de entrega'},{id:'customerPhone',name:'Número de teléfono'},{id:'deliveryLocation',name:'Ubicación'}];var errors=[];for(var i=0;i<requiredFields.length;i++){var field=requiredFields[i];var element=document.getElementById(field.id);if(!element.value.trim()){errors.push(field.name);element.classList.add('border-red-500');}else{element.classList.remove('border-red-500');}}
    var paymentMethod=document.querySelector('input[name="paymentMethod"]:checked');if(!paymentMethod){errors.push('Método de pago');}
    if(errors.length>0){alert('Por favor completa los siguientes campos:\n• '+errors.join('\n• '));return false;}
    return true;}
    
    function confirmOrder() {
        if (!validateCheckoutForm()) {
            return;
        }
        var customerName = document.getElementById('customerName').value.trim();
        var customerAddress = document.getElementById('customerAddress').value.trim();
        var customerReferences = document.getElementById('customerReferences').value.trim();
        var customerPhone = document.getElementById('customerPhone').value.trim();
        var deliveryLocation = document.getElementById('deliveryLocation').value;
        var paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        var cashAmount = selectedCashAmount === 'otro' ? document.getElementById('otherCashAmount').value.trim() : selectedCashAmount;
        var subtotal = cart.reduce(function(sum, item) { return sum + (item.price * item.quantity); }, 0);
        var serviceFee = 50;
        var shippingCost = 0;
        var shippingText = '$0';

        if (deliveryLocation === 'habana-vieja') {
            if (subtotal >= 3500) {
                shippingCost = 0;
                shippingText = 'GRATIS (Pedido Mayor a $3,500)';
            } else if (subtotal >= 1500) {
                shippingCost = 50;
                shippingText = 'Envío con Descuento: $50 CUP';
            } else {
                shippingCost = 150;
                shippingText = '$150 CUP';
            }
        } else {
            shippingText = 'A confirmar por agencia de mensajería';
        }

        var total = subtotal + serviceFee + shippingCost;
        var orderItems = cart.map(function(item) { return '• ' + item.name + ' x' + item.quantity + ' - $' + (item.price * item.quantity).toLocaleString(); }).join('\n');
        var locationText = deliveryLocation === 'habana-vieja' ? 'Habana Vieja' : 'Otros municipios';
        var paymentText = paymentMethod === 'efectivo' ? 'Efectivo' + (cashAmount ? ' (pagaré con ' + cashAmount + ')' : '') : 'Transferencia';
        var finalMessage = "*🛒 NUEVO PEDIDO - EL RESOLVITO*\n\n" +
            "*👤 DATOS DEL CLIENTE:*\n" + "• Nombre: " + customerName + "\n" + "• Teléfono: " + customerPhone + "\n" + "• Dirección: " + customerAddress + "\n" + "• Referencias: " + (customerReferences || 'No especificadas') + "\n" + "• Ubicación: " + locationText + "\n\n" + "*📦 PRODUCTOS:*\n" + orderItems + "\n\n" + "*💰 RESUMEN DE PAGO:*\n" + "• Subtotal de productos: $" + subtotal.toLocaleString() + "\n" + "• Servicio y Empaque: $" + serviceFee + "\n" + "• Envío: " + shippingText + "\n" + "• TOTAL A PAGAR: $" + total.toLocaleString() + "\n\n" + "*💳 MÉTODO DE PAGO:*\n" + paymentText + "\n\n" + "*⏰ Horario de entrega preferido:* Se coordinará para la próxima ronda de entrega.\n\n" + "_¡Gracias por su pedido!_ 🙏";

        var telegramToken = 'TU_TOKEN_DE_TELEGRAM_AQUI';
        var telegramChatId = 'TU_CHAT_ID_AQUI';
        fetch('https://api.telegram.org/bot' + telegramToken + '/sendMessage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: telegramChatId, text: finalMessage, parse_mode: 'Markdown' })
        });

        var googleAppsScriptUrl = 'https://script.google.com/macros/s/AKfycby9Sk3Fz2_WqRQsEXrezpwqKbpYhqW_-ialMJcYKPdvZkrBfNReWWFfQ-VnXTrkJY8W/exec';
        var orderData = {
            idPedido: new Date().getTime(),
            customerName: customerName,
            customerPhone: customerPhone,
            customerAddress: customerAddress,
            customerReferences: customerReferences,
            total: total,
            paymentMethod: paymentMethod,
            shippingText: shippingText,
            orderItems: orderItems
        };
        var formData = new FormData();
        for (var key in orderData) {
            if (orderData.hasOwnProperty(key)) {
                formData.append(key, orderData[key]);
            }
        }
        fetch(googleAppsScriptUrl, { method: 'POST', body: formData, mode: 'no-cors' }).catch(function(error) { console.error('Error enviando a Google Sheets:', error); });

        var whatsappPhoneNumber = '56382909';
        var whatsappMessage = encodeURIComponent(finalMessage.replace(/\*/g, '').replace(/_/g, ''));
        window.open('https://wa.me/' + whatsappPhoneNumber + '?text=' + whatsappMessage, '_blank');

        document.getElementById('checkoutModal').classList.remove('show');
        cart = [];
        updateCartUI();
        localStorage.setItem('cart', JSON.stringify(cart));
        
        var customerData = { name: customerName, address: customerAddress, references: customerReferences, phone: customerPhone };
        localStorage.setItem('customerData', JSON.stringify(customerData));
        
        alert('¡Pedido enviado! Te contactaremos pronto para confirmar los detalles.');
    }
</script>

</body>
</html>


